# Preview-PC 高保真模拟器设计文档

**项目名称**: ARS Preview-PC Simulator
**设计日期**: 2025-02-02
**版本**: 1.0
**目标**: 为 ARS AutoGUI 提供高保真的 Review PC 模拟环境

---

## 1. 项目概述

### 1.1 目标
构建一个高保真的 Review PC 模拟器，用于配合 ARS AutoGUI 进行自动化测试。模拟器需要精确还原真实软件的界面布局、按键响应流程，并提供可控的异常注入功能。

### 1.2 核心要求
- **响应速度**: ms 级别的按键响应
- **高保真度**: 窗口标题、界面布局与真实软件一致
- **可控异常**: 可按需注入卡顿、弹窗、崩溃等测试场景
- **绿色部署**: 无需安装，解压即用

### 1.3 使用场景
- 个人开发/测试使用
- ARS AutoGUI 通过截图识别界面，自动完成 "截图 → AI判图 → 按键 → 提交" 流程
- 模拟器通过注入异常测试 ARS AutoGUI 的鲁棒性

---

## 2. 整体架构设计

### 2.1 技术选型
- **框架**: PyQt6（Python 绑定）
- **解释器**: `D:/miniforge3/envs/ars_autogui/python.exe`
- **配置格式**: JSON
- **日志格式**: 文本日志 + Markdown 报告

### 2.2 架构模式
采用 **MVC 模式** 分层架构：

```
┌─────────────────────────────────────────┐
│            View Layer (视图)             │
│  主窗口 | 图片显示区 | 控制面板 | 弹窗     │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│         Controller Layer (控制器)        │
│  键盘监听 | 流程控制 | 异常注入逻辑        │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│           Model Layer (数据)             │
│  批次状态 | 图片资源 | 测试记录 | 配置     │
└─────────────────────────────────────────┘
```

### 2.3 核心模块划分

| 模块 | 职责 |
|------|------|
| **UI 模块** | 界面渲染、用户交互、窗口管理 |
| **业务逻辑模块** | 批次流程、OK/NG 判断、切图逻辑 |
| **异常注入模块** | 卡顿、弹窗、崩溃等测试场景 |
| **资源管理模块** | 图片加载、缓存、等待图管理 |
| **日志记录模块** | 按键记录、状态变更日志 |
| **配置管理模块** | 首次运行引导、配置持久化 |

### 2.4 数据流向

```
用户按键 → 键盘监听器 → 业务逻辑处理 → 状态更新 → UI刷新 → 日志记录
              ↓
         异常注入检查（可能拦截/延迟）
```

---

## 3. UI 界面设计

### 3.1 主窗口规格
- **窗口标题**: `"Review PC"`（严格固定）
- **初始大小**: 1280 x 720
- **最小尺寸**: 800 x 600
- **行为特性**:
  - 始终置顶（可配置关闭）
  - 记住窗口位置和大小
  - 支持最小化到托盘

### 3.2 布局结构（垂直布局）

```
┌────────────────────────────────────────────┐
│  状态栏 (30px)                               │
│  Batch 1 | Image 3/6 | Running | OK:1 NG:0  │
├────────────────────────────────────────────┤
│                                             │
│              图片显示区域                    │
│           (占据主要空间)                     │
│                                             │
├────────────────────────────────────────────┤
│  控制面板 (120px)                            │
│  [流程控制] [视图切换] [图片输出] [异常注入]  │
└────────────────────────────────────────────┘
```

### 3.3 状态栏元素
- **批次进度**: `Batch X | Image Y/6`
- **运行状态**: `Running / Paused / Lagging / Waiting`
- **计数器**: `OK: X | NG: Y`

### 3.4 图片显示区域

**单图模式**:
- 显示一张大图，自适应窗口大小保持比例
- 当前图片居中显示

**六宫格模式**:
- 2x3 网格布局
- 每个格子显示缩略图
- 当前处理图片显示高亮边框

### 3.5 控制面板布局

```
┌─────────────────────────────────────────────────────┐
│ [流程控制]     Start | Pause | Stop                  │
│ [视图切换]     Grid | Single                         │
│ [图片输出]     Normal | Wait                         │
│ [异常注入]     Inject Lag | Inject Popup | Crash     │
│ [报告]         Export Report                         │
└─────────────────────────────────────────────────────┘
```

**按钮功能说明**:

| 按钮 | 功能 |
|------|------|
| Start | 开始测试，进入 Running 状态 |
| Pause | 暂停测试，进入 Paused 状态 |
| Stop | 停止测试，重置到 Idle 状态 |
| Grid | 切换到六宫格视图 |
| Single | 切换到单图视图 |
| Normal | 恢复输出正常产品图 |
| Wait | 输出等待图 |
| Inject Lag | 触发卡顿（3秒或手动取消） |
| Inject Popup | 随机位置弹出干扰窗口 |
| Crash | 弹出程序崩溃对话框 |
| Export Report | 导出测试报告 |

### 3.6 模态弹窗设计

**批次完成弹窗**:
- 位置: 屏幕中央
- 标题: `"Batch Complete"`
- 内容: `"Batch X completed. OK: Y, NG: Z. Confirm to proceed?"`
- 按钮: `Confirm` / `Cancel`
- 快捷键: `Enter` 确认 / `Esc` 取消

**干扰弹窗**:
- 位置: 随机（主窗口范围内）
- 标题: 随机选择
  - `"License Warning"`
  - `"System Alert"`
  - `"Connection Lost"`
  - `"Update Available"`
- 内容: 随机提示文字
- 不阻塞主流程

**崩溃弹窗**:
- 标题: `"Review PC has stopped working"`
- 内容: 标准崩溃提示
- 按钮: `"Close the program"` / `"Debug"`
- 阻塞主流程

---

## 4. 核心业务逻辑设计

### 4.1 状态机

```
         [Idle]
            ↓
         [Running] ←→ [Paused]
            ↓
    [Waiting Confirm]
            ↓
      [Idle/Next Batch]

    [Lagging] - 可在任何状态触发
    [Crashed] - 阻塞所有操作
```

**状态详细说明**:

| 状态 | 描述 | 响应按键 |
|------|------|----------|
| Idle | 初始/空闲状态 | 无 |
| Running | 正常运行 | N/M/Enter/Esc |
| Paused | 暂停中 | 无 |
| Waiting Confirm | 等待批次确认 | Enter/Esc |
| Lagging | 卡顿中 | 无（界面正常刷新） |
| Crashed | 崩溃弹窗显示 | 无 |

### 4.2 按键处理逻辑

| 按键 | Running | Paused | Lagging | Waiting Confirm |
|------|---------|--------|---------|-----------------|
| N (OK) | 切下一张，记录OK | 忽略 | 忽略 | 忽略 |
| M (NG) | 切下一张，记录NG | 忽略 | 忽略 | 忽略 |
| Enter | 忽略 | 忽略 | 忽略 | 确认提交 |
| Esc | 忽略 | 忽略 | 忽略 | 取消批次 |

**按键处理优先级**:
1. 崩溃状态 → 阻塞所有按键
2. 卡顿状态 → 忽略 N/M
3. 等待确认 → 只响应 Enter/Esc
4. 暂停状态 → 忽略所有
5. 运行状态 → 正常响应 N/M

### 4.3 批次流程

**正常流程**:
1. 用户点击 `Start` → 进入 Running 状态
2. 按 N 或 M 切换图片（1→2→3→4→5→6）
3. 第6张图处理完毕 → 弹出确认对话框
4. 点击 `Confirm` 或按 `Enter` → 重置计数器，开始下一批次
5. 点击 `Cancel` 或按 `Esc` → 重置计数器，取消批次

**计数规则**:
- 每批次严格 6 张图片
- 正常图片不足时循环使用
- OK/NG 计数器累计所有批次

### 4.4 图片切换逻辑

```
按键触发 → 检查状态 → 更新计数 → 获取下一张图 → 刷新显示 → 记录日志
```

**关键要求**:
- 切换速度: ms 级响应
- 无动画过渡
- 强制刷新显示（确保截图能捕获变化）

---

## 5. 异常注入设计

### 5.1 图片输出控制

**输出模式**:
- `NORMAL` - 循环输出正常产品图
- `WAIT` - 固定输出等待图

**切换机制**:
- 点击控制面板按钮立即切换
- 当前显示图片同步更新
- 不影响批次进度计数器
- 可与卡顿模式组合使用

### 5.2 卡顿注入 (Inject Lag)

**实现方式**:
- 设置 `lag_until` 时间戳（固定时长）或 `lag_forever=True`（手动取消）
- 按键事件处理器检查标志，为真时忽略 N/M 按键
- 界面继续正常刷新
- 状态栏显示 `"Lagging"`

**操作方式**:
- 固定时长: 默认 3 秒（可配置）
- 手动取消: 点击 `Inject Lag` 按钮取消

### 5.3 干扰弹窗注入 (Inject Popup)

**实现方式**:
- 在主窗口范围内随机位置生成小模态对话框
- 标题和内容随机选择
- 不阻塞主流程
- 可能遮挡操作区域

**弹窗类型**:
- 许可证警告
- 系统提示
- 连接丢失
- 更新提示

### 5.4 崩溃弹窗注入 (Inject Crash)

**实现方式**:
- 模拟 Windows 程序崩溃对话框
- 标题: `"Review PC has stopped working"`
- 内容: 标准崩溃提示
- 按钮: `"Close the program"` / `"Debug"`

**效果**:
- 阻塞所有主流程操作
- 点击任意按钮后消失
- 状态恢复到触发前

---

## 6. 配置管理设计

### 6.1 配置文件结构

配置保存在程序目录下的 `config.json`（**所有路径必须使用绝对路径**）:

```json
{
  "images": {
    "normal_dir": "D:/test/images/normal",
    "wait_image": "D:/test/images/wait.png"
  },
  "window": {
    "remember_position": true,
    "always_on_top": true,
    "last_x": 100,
    "last_y": 100,
    "last_width": 1280,
    "last_height": 720
  },
  "lag_duration": 3,
  "log_file": "D:/test/logs/preview_pc.log",
  "report_dir": "D:/test/reports/"
}
```

### 6.2 首次运行引导流程

1. 检测 `config.json` 不存在 → 启动引导向导
2. **Step 1**: 选择正常图片目录（文件夹选择对话框）→ 必填
3. **Step 2**: 选择等待图（文件选择对话框）→ 必填
4. **Step 3**: 确认并保存配置

**默认路径建议**:
- 程序目录下的 `test/images/normal/`
- 程序目录下的 `test/images/wait.png`

### 6.3 配置重置功能

- 控制面板添加 `Reset Config` 按钮
- 或提供菜单选项
- 点击后重新运行引导向导
- 支持手动编辑 `config.json` 文件

---

## 7. 日志与测试报告

### 7.1 日志记录

**日志内容**:
- 按键事件: 时间戳、按键类型
- 状态变更: 模式切换、批次开始/结束
- 异常注入: 卡顿、弹窗、崩溃触发
- 错误信息: 图片加载失败、配置错误

**日志格式**:
```
[2025-02-02 14:30:15.123] [INFO] Application started
[2025-02-02 14:30:16.456] [KEY] N pressed - Image 1 → 2, OK count: 1
[2025-02-02 14:30:17.789] [KEY] M pressed - Image 2 → 3, NG count: 1
[2025-02-02 14:30:20.123] [INJECT] Lag mode activated (3s)
[2025-02-02 14:30:23.456] [INJECT] Lag mode ended
[2025-02-02 14:30:25.789] [BATCH] Batch 1 completed - OK: 4, NG: 2
[2025-02-02 14:30:28.123] [KEY] Enter pressed - Batch confirmed
```

**双输出机制**:
- **控制台**: 实时输出，便于开发调试
- **日志文件**: 按日期滚动，保留历史记录

### 7.2 测试报告导出

**报告格式**: Markdown

**报告内容**:
```markdown
# Preview-PC Test Report

**Date:** 2025-02-02 14:30:00
**Duration:** 00:05:23
**Total Batches:** 3

## Statistics
| Metric | Value |
|--------|-------|
| Total Images | 18 |
| OK | 12 |
| NG | 6 |
| OK Rate | 66.67% |

## Batch Details
| Batch # | OK | NG | Duration |
|---------|-----|-----|----------|
| 1 | 4 | 2 | 00:01:45 |
| 2 | 5 | 1 | 00:02:10 |
| 3 | 3 | 3 | 00:01:28 |

## Anomaly Injection Summary
- Lag injections: 2
- Popup injections: 1
- Crash injections: 0
```

**文件命名**: `report_YYYYMMDD_HHMMSS.md`
**保存位置**: `config.json` 中配置的 `report_dir` 目录

---

## 8. 技术实现要点

### 8.1 性能优化
- 图片预加载缓存
- 按键事件异步处理
- UI 线程与业务逻辑分离

### 8.2 窗口特性
- 窗口标题严格固定: `"Review PC"`
- 仅窗口获得焦点时响应按键
- 支持置顶、最小化
- 记住窗口位置和大小

### 8.3 异常处理
- 图片目录为空或不存在
- 配置文件损坏（使用默认值并提示）
- 运行时异常（记录日志并优雅降级）

---

## 9. 交付物

### 9.1 代码结构
```
ARS_Preview-PC/
├── main.py                 # 程序入口
├── config.json             # 配置文件（运行时生成）
├── requirements.txt        # 依赖列表
├── src/
│   ├── ui/                 # UI 模块
│   ├── core/               # 核心业务逻辑
│   ├── injectors/          # 异常注入
│   ├── resources/          # 资源管理
│   ├── logging/            # 日志记录
│   └── config/             # 配置管理
├── logs/                   # 日志目录
├── reports/                # 报告目录
└── test/
    └── images/             # 测试图片目录
        ├── normal/         # 正常产品图
        └── wait.png        # 等待图
```

### 9.2 部署方式
- 绿色便携版（PyInstaller 打包）
- 单文件或自解压包
- 首次运行自动引导配置

---

## 10. 后续扩展可能性

- 支持自定义批次大小（目前固定6张）
- 支持多种等待图随机切换
- 支持录制/回放测试场景
- 支持远程控制（HTTP API）
- 支持多语言界面

---

**设计文档版本**: 1.0
**最后更新**: 2025-02-02
