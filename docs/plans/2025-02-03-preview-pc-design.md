# Preview-PC 高保真模拟器设计文档 v2.0

**项目名称**: ARS Preview-PC Simulator
**设计日期**: 2025-02-03
**版本**: 2.0
**目标**: 为 ARS AutoGUI 提供高保真的 Review PC 模拟环境，支持动态批次和超时替换测试场景

---

## 1. 项目概述

### 1.1 目标
构建一个高保真的 Review PC 模拟器，用于配合 ARS AutoGUI 进行自动化测试。模拟器需要精确还原真实软件的界面布局、按键响应流程，并提供可控的异常注入功能。

### 1.2 核心变更（v2.0）

与 v1.0 设计相比，本次更新包含以下关键变更：

| 变更项 | v1.0 设计 | v2.0 更新 |
|--------|-----------|-----------|
| 批次大小 | 固定6张/批次 | 动态0-6张/批次，手动设置 |
| 大图模式 | 主窗口内切换单图 | 独立弹窗模式，需手动关闭 |
| 无图状态 | 手动切换wait图 | 自动检测下一批次无图时显示 |
| 超时机制 | 仅卡顿注入 | 图片超时自动替换为超时图并判M |
| 隐藏功能 | 无 | 新增托盘隐藏功能 |

### 1.3 核心要求
- **响应速度**: ms 级别的按键响应
- **高保真度**: 窗口标题、界面布局与真实软件一致
- **动态批次**: 支持 0-6 张图/批次的灵活配置
- **超时替换**: 图片超时自动触发替换并判M
- **可控异常**: 卡顿、弹窗、崩溃、隐藏桌面等测试场景
- **绿色部署**: 无需安装，解压即用

### 1.4 使用场景
- 个人开发/测试使用
- ARS AutoGUI 通过截图识别界面，自动完成 "截图 → AI判图 → 按键 → 提交" 流程
- 模拟器通过注入异常测试 ARS AutoGUI 的鲁棒性
- 支持动态批次和超时场景测试

---

## 2. 整体架构设计

### 2.1 技术选型
- **框架**: PyQt6（Python 绑定）
- **解释器**: `D:/miniforge3/envs/ars_autogui/python.exe`
- **配置格式**: JSON
- **日志格式**: 文本日志 + Markdown 报告

### 2.2 架构模式
采用 **MVC 模式** 分层架构：

```
┌─────────────────────────────────────────┐
│            View Layer (视图)             │
│  主窗口 | 六宫格 | 大图弹窗 | 托盘图标    │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│         Controller Layer (控制器)        │
│  键盘监听 | 流程控制 | 超时检测 | 异常注入  │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│           Model Layer (数据)             │
│  批次状态 | 图片资源 | 超时配置 | 测试记录  │
└─────────────────────────────────────────┘
```

### 2.3 核心模块划分

| 模块 | 职责 |
|------|------|
| **UI 模块** | 主窗口界面、六宫格视图、大图弹窗、托盘管理 |
| **业务逻辑模块** | 动态批次流程、OK/NG 判断、超时检测与替换 |
| **异常注入模块** | 卡顿、弹窗、崩溃、隐藏桌面等测试场景 |
| **资源管理模块** | 图片加载、缓存、wait图、超时图管理 |
| **日志记录模块** | 按键记录、状态变更日志、超时事件日志 |
| **配置管理模块** | 首次运行引导、配置持久化、批次数量设置 |

### 2.4 数据流向

```
用户按键 → 键盘监听器 → 超时检测 → 业务逻辑处理 → 状态更新 → UI刷新 → 日志记录
                                  ↓
                            触发超时替换流程
```

---

## 3. UI 界面设计

### 3.1 主窗口规格
- **窗口标题**: `"Review PC"`（严格固定）
- **初始大小**: 1280 x 720
- **最小尺寸**: 800 x 600
- **行为特性**:
  - 始终置顶（可配置关闭）
  - 记住窗口位置和大小
  - 支持最小化到托盘
  - 支持隐藏到托盘（新功能）

### 3.2 布局结构（垂直布局）

```
┌────────────────────────────────────────────┐
│  状态栏 (30px)                               │
│  Batch 1 | Image 2/3 | Running | OK:1 NG:0  │
├────────────────────────────────────────────┤
│                                             │
│              六宫格图片显示区域              │
│           (2x3 网格布局)                     │
│                                             │
├────────────────────────────────────────────┤
│  控制面板 (140px)                            │
│  [批次设置] [流程控制] [视图切换] [异常注入]  │
└────────────────────────────────────────────┘
```

### 3.3 状态栏元素
- **批次进度**: `Batch X | Image Y/N`（N为当前批次设置的图片数量）
- **运行状态**: `Running / Paused / Lagging / Waiting / Timeout`
- **计数器**: `OK: X | NG: Y`
- **超时倒计时**: `Timeout: 5.2s`（超时前5秒显示）

### 3.4 六宫格图片显示区域

**六宫格模式（主窗口默认）**:
- 2x3 网格布局
- 每个格子显示缩略图
- 当前处理图片显示高亮边框
- 支持点击小图打开大图弹窗
- 无图时显示灰色 wait 图

### 3.5 大图弹窗设计

**大图弹窗（独立窗口）**:
- **触发方式**: 点击六宫格中的任意小图
- **窗口标题**: `"Review PC - Image Viewer"`
- **窗口特性**:
  - 独立窗口，可移动、调整大小
  - 显示当前图片的放大版本
  - 始终置顶于主窗口之上
  - 手动关闭前保持打开状态
  - 切换图片时自动更新内容（如未关闭）
- **关闭方式**:
  - 点击窗口关闭按钮
  - 按 Esc 键关闭

### 3.6 控制面板布局

```
┌─────────────────────────────────────────────────────────────┐
│ [批次设置] 批次数量: [3▼]  Start                             │
│                                                             │
│ [流程控制]     Start | Pause | Stop                          │
│                                                             │
│ [视图切换]     Open Big Image (当前选中图)                   │
│                                                             │
│ [图片输出]     Normal | Wait                                │
│                                                             │
│ [异常注入]     Inject Lag | Inject Popup | Crash | Hide     │
│                                                             │
│ [报告]         Export Report                                 │
└─────────────────────────────────────────────────────────────┘
```

**批次设置区域（新增）**:
- **批次数量下拉框**: 可选择 0-6
- **设置逻辑**: 点击 Start 后应用，当前批次生效
- **默认值**: 6

**按钮功能说明**:

| 按钮 | 功能 |
|------|------|
| Start | 开始测试，应用批次数量设置，进入 Running 状态 |
| Pause | 暂停测试，进入 Paused 状态 |
| Stop | 停止测试，重置到 Idle 状态 |
| Open Big Image | 打开当前选中图的大图弹窗 |
| Normal | 恢复输出正常产品图 |
| Wait | 输出wait图 |
| Inject Lag | 触发卡顿（3秒或手动取消） |
| Inject Popup | 随机位置弹出干扰窗口 |
| Crash | 弹出程序崩溃对话框 |
| Hide | 隐藏程序到托盘，显示桌面 |
| Export Report | 导出测试报告 |

### 3.7 托盘图标设计

**托盘图标功能**:
- **图标样式**: 程序图标
- **右键菜单**:
  - `显示窗口` - 恢复主窗口显示
  - `暂停/继续` - 控制测试流程
  - `退出` - 关闭程序
- **双击**: 恢复主窗口显示
- **提示文本**: `"Review PC Simulator - [状态]"`

### 3.8 模态弹窗设计

**批次完成弹窗**:
- 位置: 屏幕中央
- 标题: `"Batch Complete"`
- 内容: `"Batch X completed. OK: Y, NG: Z. Confirm to proceed?"`
- 按钮: `Confirm` / `Cancel`
- 快捷键: `Enter` 确认 / `Esc` 取消

**干扰弹窗**:
- 位置: 随机（主窗口范围内）
- 标题: 随机选择
  - `"License Warning"`
  - `"System Alert"`
  - `"Connection Lost"`
  - `"Update Available"`
- 内容: 随机提示文字
- 不阻塞主流程

**崩溃弹窗**:
- 标题: `"Review PC has stopped working"`
- 内容: 标准崩溃提示
- 按钮: `"Close the program"` / `"Debug"`
- 阻塞主流程

---

## 4. 核心业务逻辑设计

### 4.1 状态机

```
         [Idle]
            ↓
         [Running] ←→ [Paused]
            ↓
         [Timeout] ←→ [Running]
            ↓
    [Waiting Confirm]
            ↓
      [Idle/Next Batch]

    [Lagging] - 可在任何状态触发
    [Crashed] - 阻塞所有操作
    [Hidden] - 隐藏到托盘，保持状态
```

**状态详细说明**:

| 状态 | 描述 | 响应按键 |
|------|------|----------|
| Idle | 初始/空闲状态 | 无 |
| Running | 正常运行 | N/M/Enter/Esc |
| Paused | 暂停中 | 无 |
| Timeout | 超时替换中 | 仅M（自动判M） |
| Waiting Confirm | 等待批次确认 | Enter/Esc |
| Lagging | 卡顿中 | 无（界面正常刷新） |
| Crashed | 崩溃弹窗显示 | 无 |
| Hidden | 隐藏到托盘 | 无（托盘操作恢复） |

### 4.2 动态批次流程

**批次设置流程**:
1. 用户在控制面板选择批次数量（0-6）
2. 点击 `Start` 开始当前批次
3. 批次进度显示为 `Image X/N`（N为设置的批次数量）
4. 处理完N张图后弹出确认对话框

**无图批次处理**:
- 当批次数量为 0 时，直接进入 wait 状态
- 六宫格全部显示灰色 wait 图
- 大图弹窗显示 wait 图放大版
- 状态栏显示 `Waiting` 状态

**下一批次无图检测**:
- 当前批次确认后，检查是否有下一批次图片
- 如无图，全部显示 wait 图并等待
- 等待超时后自动进入超时替换流程

### 4.3 按键处理逻辑

| 按键 | Running | Paused | Timeout | Waiting Confirm |
|------|---------|--------|---------|-----------------|
| N (OK) | 切下一张，记录OK | 忽略 | 替换超时图后生效 | 忽略 |
| M (NG) | 切下一张，记录NG | 忽略 | 替换超时图后生效 | 忽略 |
| Enter | 忽略 | 忽略 | 忽略 | 确认提交 |
| Esc | 忽略 | 忽略 | 关闭大图弹窗 | 取消批次 |

**按键处理优先级**:
1. 崩溃状态 → 阻塞所有按键
2. 隐藏状态 → 无响应
3. 卡顿状态 → 忽略 N/M
4. 超时状态 → N/M 均判M并切换
5. 等待确认 → 只响应 Enter/Esc
6. 暂停状态 → 忽略所有
7. 运行状态 → 正常响应 N/M

### 4.4 超时检测与替换逻辑

**超时检测机制**:
```
图片显示 → 启动超时计时器 → 超时触发 → 替换为超时图 → 等待按键 → 判M → 切下一张
```

**超时配置**:
- 每张图片可配置独立的超时时间
- 默认超时时间: 10秒（可配置）
- 超时前5秒显示倒计时

**超时替换流程**:
1. 当前图片显示超过配置的超时时间
2. 自动替换为超时图（从超时图文件夹随机选择）
3. 界面保持刷新，状态栏显示 `Timeout`
4. 等待用户按键（N或M）
5. 收到任意按键后，记录为 NG（判M）
6. 切换到下一张图

**超时图管理**:
- 配置 `timeout_dir` 文件夹路径
- 程序启动时加载所有超时图
- 超时时随机选择一张显示
- 支持循环使用

### 4.5 大图弹窗逻辑

**打开大图弹窗**:
- 触发方式:
  1. 点击六宫格中的任意小图
  2. 点击控制面板 `Open Big Image` 按钮
- 弹窗显示当前选中图片的放大版本
- 独立窗口，不影响主窗口操作

**大图弹窗与图片切换**:
- 如大图弹窗未关闭，切换图片时自动更新内容
- 保持弹窗打开状态，持续显示最新图片
- 用户手动关闭后，需重新点击打开

---

## 5. 异常注入设计

### 5.1 图片输出控制

**输出模式**:
- `NORMAL` - 循环输出正常产品图
- `WAIT` - 固定输出wait图

**切换机制**:
- 点击控制面板按钮立即切换
- 当前显示图片同步更新
- 不影响批次进度计数器
- 可与卡顿模式组合使用

### 5.2 卡顿注入 (Inject Lag)

**实现方式**:
- 设置 `lag_until` 时间戳（固定时长）或 `lag_forever=True`（手动取消）
- 按键事件处理器检查标志，为真时忽略 N/M 按键
- 界面继续正常刷新
- 状态栏显示 `"Lagging"`

**操作方式**:
- 固定时长: 默认 3 秒（可配置）
- 手动取消: 点击 `Inject Lag` 按钮取消

### 5.3 干扰弹窗注入 (Inject Popup)

**实现方式**:
- 在主窗口范围内随机位置生成小模态对话框
- 标题和内容随机选择
- 不阻塞主流程
- 可能遮挡操作区域

**弹窗类型**:
- 许可证警告
- 系统提示
- 连接丢失
- 更新提示

### 5.4 崩溃弹窗注入 (Inject Crash)

**实现方式**:
- 模拟 Windows 程序崩溃对话框
- 标题: `"Review PC has stopped working"`
- 内容: 标准崩溃提示
- 按钮: `"Close the program"` / `"Debug"`

**效果**:
- 阻塞所有主流程操作
- 点击任意按钮后消失
- 状态恢复到触发前

### 5.5 隐藏桌面注入 (Hide) - 新增

**实现方式**:
- 点击 `Hide` 按钮
- 主窗口隐藏到系统托盘
- 显示桌面（程序不可见）
- 状态保持不变

**恢复方式**:
- 双击托盘图标
- 右键菜单选择 `显示窗口`
- 快捷键唤醒（可配置）

**测试场景**:
- 验证 ARS AutoGUI 能否检测窗口丢失
- 验证窗口恢复后的状态正确性

---

## 6. 配置管理设计

### 6.1 配置文件结构

配置保存在程序目录下的 `config.json`（**所有路径必须使用绝对路径**）:

```json
{
  "images": {
    "normal_dir": "D:/test/images/normal",
    "wait_image": "D:/test/images/wait.png",
    "timeout_dir": "D:/test/images/timeout"
  },
  "window": {
    "remember_position": true,
    "always_on_top": true,
    "last_x": 100,
    "last_y": 100,
    "last_width": 1280,
    "last_height": 720
  },
  "timeout": {
    "default_duration": 10,
    "show_countdown": true,
    "countdown_seconds": 5
  },
  "batch": {
    "default_count": 6
  },
  "lag_duration": 3,
  "log_file": "D:/test/logs/preview_pc.log",
  "report_dir": "D:/test/reports/",
  "tray": {
    "enabled": true,
    "minimize_to_tray": true
  }
}
```

### 6.2 首次运行引导流程

1. 检测 `config.json` 不存在 → 启动引导向导
2. **Step 1**: 选择正常图片目录（文件夹选择对话框）→ 必填
3. **Step 2**: 选择等待图（文件选择对话框）→ 必填
4. **Step 3**: 选择超时图目录（文件夹选择对话框）→ 必填
5. **Step 4**: 确认并保存配置

**默认路径建议**:
- 程序目录下的 `test/images/normal/`
- 程序目录下的 `test/images/wait.png`
- 程序目录下的 `test/images/timeout/`

### 6.3 配置重置功能

- 控制面板添加 `Reset Config` 按钮
- 或提供菜单选项
- 点击后重新运行引导向导
- 支持手动编辑 `config.json` 文件

---

## 7. 日志与测试报告

### 7.1 日志记录

**日志内容**:
- 按键事件: 时间戳、按键类型
- 状态变更: 模式切换、批次开始/结束
- 超时事件: 超时触发、替换图、按键恢复
- 异常注入: 卡顿、弹窗、崩溃、隐藏触发
- 错误信息: 图片加载失败、配置错误

**日志格式**:
```
[2025-02-03 14:30:15.123] [INFO] Application started
[2025-02-03 14:30:16.456] [KEY] N pressed - Image 1 → 2, OK count: 1
[2025-02-03 14:30:17.789] [KEY] M pressed - Image 2 → 3, NG count: 1
[2025-02-03 14:30:20.123] [TIMEOUT] Image 4 timeout after 10s, replaced with timeout_03.png
[2025-02-03 14:30:21.456] [KEY] N pressed after timeout - Auto marked as NG, NG count: 2
[2025-02-03 14:30:25.789] [INJECT] Lag mode activated (3s)
[2025-02-03 14:30:28.456] [INJECT] Lag mode ended
[2025-02-03 14:30:30.789] [INJECT] Hidden to tray
[2025-02-03 14:30:35.123] [BATCH] Batch 1 completed - OK: 2, NG: 1, Timeout: 1
```

**双输出机制**:
- **控制台**: 实时输出，便于开发调试
- **日志文件**: 按日期滚动，保留历史记录

### 7.2 测试报告导出

**报告格式**: Markdown

**报告内容**:
```markdown
# Preview-PC Test Report

**Date:** 2025-02-03 14:30:00
**Duration:** 00:05:23
**Total Batches:** 3

## Statistics
| Metric | Value |
|--------|-------|
| Total Images | 12 |
| OK | 8 |
| NG | 3 |
| Timeout | 1 |
| OK Rate | 66.67% |

## Batch Details
| Batch # | Count | OK | NG | Timeout | Duration |
|---------|-------|-----|-----|---------|----------|
| 1 | 3 | 2 | 0 | 1 | 00:01:15 |
| 2 | 6 | 4 | 1 | 0 | 00:02:30 |
| 3 | 3 | 2 | 2 | 0 | 00:01:38 |

## Timeout Summary
| Time | Image # | Timeout Duration | Replaced With | Result |
|------|---------|------------------|---------------|--------|
| 14:30:20 | 4 | 10.5s | timeout_03.png | NG (auto) |

## Anomaly Injection Summary
- Lag injections: 2
- Popup injections: 1
- Crash injections: 0
- Hide to tray: 1
```

**文件命名**: `report_YYYYMMDD_HHMMSS.md`
**保存位置**: `config.json` 中配置的 `report_dir` 目录

---

## 8. 技术实现要点

### 8.1 性能优化
- 图片预加载缓存
- 按键事件异步处理
- UI 线程与业务逻辑分离
- 超时计时器独立线程

### 8.2 窗口特性
- 主窗口标题严格固定: `"Review PC"`
- 大图弹窗标题: `"Review PC - Image Viewer"`
- 仅窗口获得焦点时响应按键
- 支持置顶、最小化、托盘隐藏
- 记住窗口位置和大小

### 8.3 超时实现要点
- 使用 QTimer 实现超时检测
- 每张图片显示时重置计时器
- 收到按键时取消计时器
- 超时触发后显示替换图并等待
- 记录超时事件到日志

### 8.4 异常处理
- 图片目录为空或不存在
- 配置文件损坏（使用默认值并提示）
- 运行时异常（记录日志并优雅降级）
- 超时图文件夹为空（使用wait图代替）

---

## 9. 交付物

### 9.1 代码结构
```
ARS_Preview-PC/
├── main.py                 # 程序入口
├── config.json             # 配置文件（运行时生成）
├── requirements.txt        # 依赖列表
├── src/
│   ├── ui/                 # UI 模块
│   │   ├── main_window.py      # 主窗口
│   │   ├── grid_widget.py      # 六宫格视图
│   │   ├── big_image_dialog.py # 大图弹窗
│   │   └── tray_icon.py        # 托盘图标
│   ├── core/               # 核心业务逻辑
│   │   ├── batch_manager.py    # 批次管理
│   │   ├── key_handler.py      # 按键处理
│   │   └── timeout_manager.py  # 超时管理
│   ├── injectors/          # 异常注入
│   │   ├── lag_injector.py     # 卡顿注入
│   │   ├── popup_injector.py   # 弹窗注入
│   │   ├── crash_injector.py   # 崩溃注入
│   │   └── hide_injector.py    # 隐藏注入
│   ├── resources/          # 资源管理
│   │   ├── image_loader.py     # 图片加载
│   │   └── image_cache.py      # 图片缓存
│   ├── logging/            # 日志记录
│   │   └── logger.py           # 日志记录器
│   └── config/             # 配置管理
│       ├── config_manager.py   # 配置管理
│       └── setup_wizard.py     # 首次运行向导
├── logs/                   # 日志目录
├── reports/                # 报告目录
└── test/
    └── images/             # 测试图片目录
        ├── normal/         # 正常产品图
        ├── wait.png        # 等待图
        └── timeout/        # 超时图
```

### 9.2 部署方式
- 绿色便携版（PyInstaller 打包）
- 单文件或自解压包
- 首次运行自动引导配置

---

## 10. 后续扩展可能性

- 支持批次配置文件预定义
- 支持多种超时图随机切换策略
- 支持录制/回放测试场景
- 支持远程控制（HTTP API）
- 支持多语言界面
- 支持快捷键自定义
- 支持多显示器配置

---

**设计文档版本**: 2.0
**最后更新**: 2025-02-03
